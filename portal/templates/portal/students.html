{% extends 'base.html' %}
{% load static %}

{% block page_title %}Students Management{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Students</h2>
    <div>
        <a href="{% url 'portal:student_create' %}" class="btn btn-netflix me-2">
            <i class="bi bi-plus-circle me-1"></i> Add Student
        </a>
        <button class="btn btn-netflix-outline me-2" data-bs-toggle="modal" data-bs-target="#importModal">
            <i class="bi bi-upload me-1"></i> Import CSV
        </button>
        <a href="{% url 'portal:students_export_csv' %}{% if q %}?q={{ q }}{% endif %}" class="btn btn-netflix-outline me-2">
            <i class="bi bi-download me-1"></i> Export CSV
        </a>
        <button id="bulkSendBtn" class="btn btn-netflix" disabled>
            <i class="bi bi-send me-1"></i> Send Selected
        </button>
    </div>
</div>

<!-- Search and filter form -->
<div class="netflix-card p-3 mb-4">
    <div class="row">
        <div class="col-md-8">
            <form method="get" class="d-flex">
                <input type="text" name="q" value="{{ q }}" class="form-control netflix-form-control me-2" 
                       placeholder="Search by name, email, hallticket or course">
                <button type="submit" class="btn btn-netflix-outline">Search</button>
            </form>
        </div>
        <div class="col-md-4 text-end">
            <div class="form-check form-switch d-inline-block me-3">
                <input class="form-check-input" type="checkbox" id="selectAll" style="background-color: #333;">
                <label class="form-check-label" for="selectAll">Select All</label>
            </div>
        </div>
    </div>
</div>

<!-- Students table -->
<div class="netflix-card">
    <div class="table-responsive">
        <table class="table netflix-table">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">
                        <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                    </th>
                    <th scope="col">Hallticket</th>
                    <th scope="col">Name</th>
                    <th scope="col">Course</th>
                    <th scope="col">Email</th>
                    <th scope="col">Template</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for student in page_obj %}
                <tr>
                    <td>{{ student.sno }}</td>
                    <td>
                        <input class="form-check-input row-checkbox" type="checkbox" value="{{ student.sno }}">
                    </td>
                    <td>{{ student.hallticket }}</td>
                    <td>{{ student.name }}</td>
                    <td>{{ student.course }}</td>
                    <td>{{ student.email }}</td>
                    <td>
                        {% if student.template %}
                        <span class="badge-netflix">{{ student.template.name }}</span>
                        {% else %}
                        <span class="badge bg-warning">No template</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="{% url 'portal:student_edit' student.sno %}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a href="{% url 'portal:student_delete' student.sno %}" class="btn btn-outline-danger btn-sm" 
                               onclick="return confirm('Are you sure you want to delete this student?')">
                                <i class="bi bi-trash"></i>
                            </a>
                            <a href="{% url 'portal:send_single' student.sno %}" class="btn btn-outline-success btn-sm">
                                <i class="bi bi-send"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="text-center py-4">No students found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page=1{% if q %}&q={{ q }}{% endif %}" aria-label="First">
                <span aria-hidden="true">&laquo;&laquo;</span>
            </a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}{% if q %}&q={{ q }}{% endif %}">{{ num }}</a></li>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if q %}&q={{ q }}{% endif %}" aria-label="Last">
                <span aria-hidden="true">&raquo;&raquo;</span>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content netflix-card">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">Import Students from CSV</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'portal:students_import_csv' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="csvFile" class="form-label">CSV File</label>
                        <input class="form-control netflix-form-control" type="file" id="csvFile" name="file" accept=".csv" required>
                        <div class="form-text text-muted">CSV format: hallticket,name,course,email,phone</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-netflix-outline" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-netflix">Import</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Select all checkbox functionality
    $('#selectAllCheckbox').change(function() {
        $('.row-checkbox').prop('checked', this.checked);
        updateBulkSendButton();
    });
    
    // Individual checkbox functionality
    $('.row-checkbox').change(function() {
        if (!this.checked) {
            $('#selectAllCheckbox').prop('checked', false);
        }
        updateBulkSendButton();
    });
    
    function updateBulkSendButton() {
        const checkedCount = $('.row-checkbox:checked').length;
        $('#bulkSendBtn').prop('disabled', checkedCount === 0);
        if (checkedCount > 0) {
            $('#bulkSendBtn').html(`<i class="bi bi-send me-1"></i> Send Selected (${checkedCount})`);
        } else {
            $('#bulkSendBtn').html('<i class="bi bi-send me-1"></i> Send Selected');
        }
    }
    
    // Bulk send functionality
    $('#bulkSendBtn').click(function() {
        const selectedIds = [];
        $('.row-checkbox:checked').each(function() {
            selectedIds.push($(this).val());
        });
        
        if (selectedIds.length === 0) return;
        
        const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
        progressModal.show();
        
        let processed = 0;
        const total = selectedIds.length;
        
        function updateProgress() {
            const percentage = Math.round((processed / total) * 100);
            $('#progressBar').css('width', percentage + '%').attr('aria-valuenow', percentage).text(percentage + '%');
            $('#progressNote').text(`Processed ${processed} of ${total} certificates (${percentage}%)`);
            
            if (processed === total) {
                $('#progressNote').html('<div class="text-success"><i class="bi bi-check-circle-fill"></i> All certificates sent successfully!</div>');
            }
        }
        
        // Process each ID with a delay to show progress
        function processNext() {
            if (processed >= total) return;
            
            const studentId = selectedIds[processed];
            
            $.ajax({
                url: "{% url 'portal:bulk_send' %}",
                method: 'POST',
                data: {
                    'ids[]': studentId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    processed++;
                    updateProgress();
                    
                    if (processed < total) {
                        setTimeout(processNext, 500);
                    }
                },
                error: function() {
                    processed++;
                    updateProgress();
                    
                    if (processed < total) {
                        setTimeout(processNext, 500);
                    }
                }
            });
        }
        
        // Start processing
        processNext();
    });
});
</script>
{% endblock %}